(function(factory){if(typeof define==="function"&&define.amd){define(["jquery"],factory)}else{if(typeof exports==="object"&&typeof module==="object"){factory(require("jquery"))}else{if(window.jQuery){factory(window.jQuery)}else{throw new Error("Not found jQuery.")}}}})(function($){var VERSION="0.1.20";var $window=$(window);var isIe="ActiveXObject" in window;var inputLock;var notNeedCalcPadding;var chromeVer=navigator.userAgent.match(/Chrome\/(\d+)/);if(chromeVer){chromeVer=Number(chromeVer[1])}notNeedCalcPadding=isIe||chromeVer>51;function handleError(e1,e2){if(!window.console||!window.console.trace){return}console.trace(e1);if(e2){console.trace(e2)}}function getPointKeyword($list){return $list.data()}function setOrGetAlt($input,val){return val?$input.attr("alt",val):$input.attr("alt")}function setValue($input,keywords,options){if(!keywords||!keywords.key){return}var separator=options.separator||",",inputValList;if(options&&options.multiWord){inputValList=$input.val().split(separator);inputValList[inputValList.length-1]=keywords.key;$input.val(inputValList.join(separator)).focus()}else{$input.attr("data-id",keywords.id).focus().val(keywords.key)}$input.trigger("onSetSelectValue",[keywords,(options.data.value||options._lastData.value)[keywords.index]])}function adjustDropMenuPos($input,$dropdownMenu,options){if(!$dropdownMenu.is(":visible")){return}if(options.autoDropup){setTimeout(function(){var $inputGroup=$dropdownMenu.parents(".input-group");if(($window.height()+$window.scrollTop()-$input.offset().top)<$dropdownMenu.height()&&$input.offset().top>($dropdownMenu.height()+$window.scrollTop())){$inputGroup.addClass("dropup")}else{$inputGroup.removeClass("dropup")}},10)}var dmcss={};var $parent=$input.parent();if(options.listAlign==="left"){dmcss={"left":$input.siblings("div").width()-$parent.width(),"right":"auto"}}else{if(options.listAlign==="right"){dmcss={"left":"auto","right":0}}}if(isIe&&!options.showBtn){if(!$dropdownMenu.parents(".input-group").hasClass("dropup")){dmcss.top=$parent.height();dmcss.bottom="auto"}else{dmcss.top="auto";dmcss.bottom=$parent.height()}}if(!options.autoMinWidth){dmcss["min-width"]=$parent.width()}$dropdownMenu.css(dmcss);return $input}function setBackground($input,options){var inputbg,bg,warnbg;if((options.indexId===-1&&!options.idField)||options.multiWord){return $input}inputbg=$input.css("background-color").replace(/ /g,"").split(",",3).join(",");bg=options.inputBgColor||"rgba(255,255,255,0.1)";warnbg=options.inputWarnColor||"rgba(255,255,0,0.1)";if($input.attr("data-id")||!$input.val()){return $input.css("background",bg)}if(!~warnbg.indexOf(inputbg)){$input.trigger("onUnsetSelectValue").css("background",warnbg)}return $input}function adjustScroll($input,$dropdownMenu,options){var $hover=$input.parent().find("tbody tr."+options.listHoverCSS),pos,maxHeight;if($hover.length){pos=($hover.index()+3)*$hover.height();maxHeight=Number($dropdownMenu.css("max-height").replace("px",""));if(pos>maxHeight||$dropdownMenu.scrollTop()>maxHeight){pos=pos-maxHeight}else{pos=0}$dropdownMenu.scrollTop(pos)}}function unHoverAll($dropdownMenu,options){$dropdownMenu.find("tr."+options.listHoverCSS).removeClass(options.listHoverCSS)}function checkInput($input,$dropdownMenu,options){if(!$dropdownMenu.length||$input.data("bsSuggest")){return false}$input.data("bsSuggest",{options:options});return true}function checkData(data){var isEmpty=true,o;for(o in data){if(o==="value"){isEmpty=false;break}}if(isEmpty){handleError("返回数据格式错误!");return false}if(!data.value.length){return false}return data}function inEffectiveFields(field,options){var effectiveFields=options.effectiveFields;return !(field==="__index"||effectiveFields.length&&!~$.inArray(field,effectiveFields))}function inSearchFields(field,options){return ~$.inArray(field,options.searchFields)}function refreshDropMenu($input,data,options){var $dropdownMenu=$input.parent().find("ul.dropdown-menu"),len,i,j,index=0,tds,html=['<table class="table table-condensed table-sm" style="margin:0">'],idValue,keyValue;if(!data||!(len=data.value.length)){$dropdownMenu.empty().hide();return $input}var dataList=data.value;if(options._lastData&&JSON.stringify(options._lastData.value)===JSON.stringify(dataList)&&$dropdownMenu.find("tr").length===len){$dropdownMenu.show();adjustDropMenuPos($input,$dropdownMenu,options);return $input}options._lastData=data;if(options.showHeader){html.push("<thead><tr>");for(j in dataList[0]){if(!inEffectiveFields(j,options)){continue}html.push("<th>",(options.effectiveFieldsAlias[j]||j),index===0?("("+len+")"):"","</th>");index++}html.push("</tr></thead>")}html.push("<tbody>");var dataI;for(i=0;i<len;i++){index=0;tds=[];dataI=dataList[i];idValue=dataI[options.idField]||"";keyValue=dataI[options.keyField]||"";for(j in dataI){if(!keyValue&&options.indexKey===index){keyValue=dataI[j]}if(!idValue&&options.indexId===index){idValue=dataI[j]}index++;if(!inEffectiveFields(j,options)){continue}tds.push('<td data-name="',j,'">',dataI[j],"</td>")
}html.push('<tr data-index="',(dataI.__index||i),'" data-id="',idValue,'" data-key="',keyValue,'">',tds.join(""),"</tr>")}html.push("</tbody></table>");$dropdownMenu.html(html.join("")).show();setTimeout(function(){if(notNeedCalcPadding){return}var $table=$dropdownMenu.find("table:eq(0)"),pdr=0,mgb=0;if($dropdownMenu.height()<$table.height()&&Number($dropdownMenu.css("min-width").replace("px",""))<$dropdownMenu.width()){pdr=18;mgb=20}$dropdownMenu.css("padding-right",pdr);$table.css("margin-bottom",mgb)},301);adjustDropMenuPos($input,$dropdownMenu,options);return $input}function ajax(options,keyword){keyword=keyword||"";var ajaxParam={type:"GET",dataType:options.jsonp?"jsonp":"json",timeout:5000};if(options.jsonp){ajaxParam.jsonp=options.jsonp}if($.isFunction(options.fnAdjustAjaxParam)){ajaxParam=$.extend(ajaxParam,options.fnAdjustAjaxParam(keyword,options))}ajaxParam.url=function(){if(!keyword||ajaxParam.data){return ajaxParam.url||options.url}var type="?";if(/=$/.test(options.url)){type=""}else{if(/\?/.test(options.url)){type="&"}}return options.url+type+keyword}();return $.ajax(ajaxParam).done(function(result){options.data=options.fnProcessData(result)}).fail(handleError)}function isInWord(keyword,key,value,options){value=$.trim(value);if(options.ignorecase){keyword=keyword.toLocaleLowerCase();value=value.toLocaleLowerCase()}return value&&(inEffectiveFields(key,options)||inSearchFields(key,options))&&(~value.indexOf(keyword)||options.twoWayMatch&&~keyword.indexOf(value))}function getData(keyword,$input,callback,options){var data,validData,filterData={value:[]},i,key,len;keyword=keyword||"";if($.isFunction(options.fnPreprocessKeyword)){keyword=options.fnPreprocessKeyword(keyword,options)}if(options.url){ajax(options,keyword).done(function(result){callback($input,options.data,options);$input.trigger("onDataRequestSuccess",result);if(options.getDataMethod==="firstByUrl"){options.url=null}})}else{data=options.data;validData=checkData(data);if(validData){if(!keyword){filterData=data}else{len=data.value.length;for(i=0;i<len;i++){for(key in data.value[i]){if(data.value[i][key]&&isInWord(keyword,key,data.value[i][key]+"",options)){filterData.value.push(data.value[i]);filterData.value[filterData.value.length-1].__index=i;break}}}}}callback($input,filterData,options)}}function processData(data){return checkData(data)}function getIClear($input,options){var $iClear=$input.prev("i.clearable");if(options.clearable&&!$iClear.length){$iClear=$('<i class="clearable glyphicon glyphicon-remove"></i>').prependTo($input.parent())}return $iClear.css({position:"absolute",top:12,right:options.showBtn?($input.next(".input-group-btn").width()||33)+2:12,zIndex:4,cursor:"pointer",fontSize:12}).hide()}var defaultOptions={url:null,jsonp:null,data:{value:[]},indexId:0,indexKey:0,idField:"",keyField:"",autoSelect:true,allowNoKeyword:true,getDataMethod:"firstByUrl",delayUntilKeyup:false,ignorecase:false,effectiveFields:[],effectiveFieldsAlias:{},searchFields:[],twoWayMatch:true,multiWord:false,separator:",",delay:300,autoDropup:false,autoMinWidth:false,showHeader:false,showBtn:true,inputBgColor:"",inputWarnColor:"rgba(255,0,0,.1)",listStyle:{"padding-top":0,"max-height":"375px","max-width":"800px","overflow":"auto","width":"auto","transition":"0.3s","-webkit-transition":"0.3s","-moz-transition":"0.3s","-o-transition":"0.3s"},listAlign:"left",listHoverStyle:"background: #07d; color:#fff",listHoverCSS:"jhover",clearable:false,keyLeft:37,keyUp:38,keyRight:39,keyDown:40,keyEnter:13,fnProcessData:processData,fnGetData:getData,fnAdjustAjaxParam:null,fnPreprocessKeyword:null};var methods={init:function(options){var self=this;options=options||{};if(undefined===options.showHeader&&options.effectiveFields&&options.effectiveFields.length>1){options.showHeader=true}options=$.extend(true,{},defaultOptions,options);if(options.processData){options.fnProcessData=options.processData}if(options.getData){options.fnGetData=options.getData}if(options.getDataMethod==="firstByUrl"&&options.url&&!options.delayUntilKeyup){ajax(options).done(function(result){options.url=null;self.trigger("onDataRequestSuccess",result)})}if(!$("#bsSuggest").length){$("head:eq(0)").append('<style id="bsSuggest">.'+options.listHoverCSS+"{"+options.listHoverStyle+"}</style>")}return self.each(function(){var $input=$(this),$parent=$input.parent(),$iClear=getIClear($input,options),mouseenterDropdownMenu,keyupTimer,$dropdownMenu=$input.parents(".input-group").find("ul.dropdown-menu:eq(0)");if(!checkInput($input,$dropdownMenu,options)){console.warn("不是一个标准的 bootstrap 下拉式菜单或已初始化:",$input);return}if(!options.showBtn){$input.css("border-radius","4px").parents(".input-group:eq(0)").css("width","100%").find(".btn:eq(0)").hide()}$input.removeClass("disabled").prop("disabled",false).attr("autocomplete","off");$dropdownMenu.css(options.listStyle);if(!options.inputBgColor){options.inputBgColor=$input.css("background-color")}$input.on("keydown",function(event){var currentList,tipsKeyword;if(!$dropdownMenu.is(":visible")){return
}currentList=$dropdownMenu.find("."+options.listHoverCSS);tipsKeyword="";unHoverAll($dropdownMenu,options);if(event.keyCode===options.keyDown){if(!currentList.length){tipsKeyword=getPointKeyword($dropdownMenu.find("tbody tr:first").mouseover())}else{if(!currentList.next().length){if(options.autoSelect){$input.val(setOrGetAlt($input)).attr("data-id","")}}else{tipsKeyword=getPointKeyword(currentList.next().mouseover())}}adjustScroll($input,$dropdownMenu,options);if(!options.autoSelect){return}}else{if(event.keyCode===options.keyUp){if(!currentList.length){tipsKeyword=getPointKeyword($dropdownMenu.find("tbody tr:last").mouseover())}else{if(!currentList.prev().length){if(options.autoSelect){$input.val(setOrGetAlt($input)).attr("data-id","")}}else{tipsKeyword=getPointKeyword(currentList.prev().mouseover())}}adjustScroll($input,$dropdownMenu,options);if(!options.autoSelect){return}}else{if(event.keyCode===options.keyEnter){tipsKeyword=getPointKeyword(currentList);$dropdownMenu.hide()}else{$input.attr("data-id","")}}}setValue($input,tipsKeyword,options)}).on("compositionstart",function(event){inputLock=true}).on("compositionend",function(event){inputLock=false}).on("keyup input paste",function(event){var word;if(~$.inArray(event.keyCode,[options.keyDown,options.keyUp,options.keyEnter])){$input.val($input.val());setBackground($input,options);return}if(event.keyCode){setBackground($input,options)}clearTimeout(keyupTimer);keyupTimer=setTimeout(function(){if(inputLock){return}word=$input.val();if($.trim(word)&&word===setOrGetAlt($input)){return}setOrGetAlt($input,word);if(options.multiWord){word=word.split(options.separator).reverse()[0]}if(!word.length&&!options.allowNoKeyword){return}options.fnGetData($.trim(word),$input,refreshDropMenu,options)},options.delay||300)}).on("focus",function(){adjustDropMenuPos($input,$dropdownMenu,options)}).on("blur",function(){if(!mouseenterDropdownMenu){$dropdownMenu.css("display","")}}).on("click",function(){var word=$input.val();if($.trim(word)&&word===setOrGetAlt($input)&&$dropdownMenu.find("table tr").length){return $dropdownMenu.show()}if($dropdownMenu.is(":visible")){return}if(options.multiWord){word=word.split(options.separator).reverse()[0]}if(!word.length&&!options.allowNoKeyword){return}options.fnGetData($.trim(word),$input,refreshDropMenu,options)});$parent.find(".btn:eq(0)").attr("data-toggle","").click(function(){var display="none";if($dropdownMenu.css("display")===display){display="block";if(options.url){$input.click().focus();if(!$dropdownMenu.find("tr").length){display="none"}}else{refreshDropMenu($input,options.data,options)}}$dropdownMenu.css("display",display);return false});$dropdownMenu.mouseenter(function(){mouseenterDropdownMenu=1;$input.blur()}).mouseleave(function(){mouseenterDropdownMenu=0;$input.focus()}).on("mouseenter","tbody tr",function(){unHoverAll($dropdownMenu,options);$(this).addClass(options.listHoverCSS);return false}).on("mousedown","tbody tr",function(){var keywords=getPointKeyword($(this));setValue($input,keywords,options);setOrGetAlt($input,keywords.key);setBackground($input,options);$dropdownMenu.hide()});if($iClear.length){$iClear.click(function(){$input.val("").attr("data-id","");setBackground($input,options)});$parent.mouseenter(function(){if(!$input.prop("disabled")){$iClear.show()}}).mouseleave(function(){$iClear.hide()})}})},show:function(){return this.each(function(){$(this).click()})},hide:function(){return this.each(function(){$(this).parent().find("ul.dropdown-menu").css("display","")})},disable:function(){return this.each(function(){$(this).attr("disabled",true).parent().find(".btn:eq(0)").prop("disabled",true)})},enable:function(){return this.each(function(){$(this).attr("disabled",false).parent().find(".btn:eq(0)").prop("disabled",false)})},destroy:function(){return this.each(function(){$(this).off().removeData("bsSuggest").removeAttr("style").parent().find(".btn:eq(0)").off().show().attr("data-toggle","dropdown").prop("disabled",false).next().css("display","").off()})},version:function(){return VERSION}};$.fn.bsSuggest=function(options){if(typeof options==="string"&&methods[options]){var inited=true;this.each(function(){if(!$(this).data("bsSuggest")){return inited=false}});if(!inited&&"init"!==options&&"version"!==options){return this}return methods[options].apply(this,[].slice.call(arguments,1))}else{return methods.init.apply(this,arguments)}}});