<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>图表统计</title>
  <!--基础样式-->
  <th:block th:include="common/pub_head :: default"></th:block>
  <th:block th:include="common/pub_head :: base-css"></th:block>
  <!--主题色-->
  <th:block th:include="common/pub_head :: theme-blue"></th:block>

  <link type="text/css" rel="stylesheet" th:href="@{/assets/font/log/iconfont.css}"/>
  <style>
    .fixed-table-container {
      border: none;
    }

    html, body {
      overflow: hidden;
    }

    .bor_view {
      height: 400px
    }

    .echart_view {
      width: 570px;
      height: 430px;
      padding: 8px;
      display: none;
    }
  </style>
</head>

<body>
<div class="wrapper-content">
  <div class="box">
    <div class="box-header with-border">
      <div class="box-title dec_1 theme-border-left">图表统计<i class='iconfont slice33'></i></div>
    </div>
    <div class="box-body">
      <div class="input-group fl col-xs-7" style="margin-top:0px; positon:relative">
        <input type="text" id="echartNameQuery" class="form-control" placeholder="请输入字段名"/>
        <span class="input-group-btn">
           <button class="btn btn-info btn-search" onclick="$('#table').bootstrapTable('refresh')">
             <i class="iconfont icon-sousuo"></i>查找</button>
        </span>
      </div>
      <!-- 表格 -->
      <div class="fr mt15 mb10">
        <button type="button" class="btn btn-primary" data-toggle="modal" onclick="saveModal()" id="add_btn">
          <span class="glyphicon glyphicon-plus"></span>
          添加
        </button>
        <button type="button" class="btn btn-danger">
          <span class="glyphicon glyphicon-remove"></span>
          删除
        </button>
      </div>
      <table id="table"></table>
    </div>
  </div>
</div>

<!-- 模态框 -->
<div class="modal fade" id="Modal_view" tabindex="-1" role="dialog" aria-labelledby="myModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
        <h4 class="modal-title" id="myModalLabel">添加图表</h4>
      </div>
      <div class="modal-body" style="min-height: 300px;">
        <form role="form" class="form-horizontal row" id="list_form">
          <div class="col-sm-6">
            <div class="form-group">
              <label class="col-sm-3 control-label">
                图表名称:</label>
              <div class="col-sm-9">
                <input type="text" class="form-control input-sm" id="echartName" name="echartName" placeholder="请输入名字"/>
              </div>
            </div>
          </div>
          <div class="col-sm-6">
            <div class="form-group">
              <label class="col-sm-3 control-label">
                图表类型:</label>
              <div class="col-sm-9">
                <select class="form-control input-sm" id="type" name="type" onchange="changeType()">
                  <option value="1" selected>折线图</option>
                  <option value="2">柱状图</option>
                  <option value="3">饼状图</option>
                </select>
              </div>
            </div>
          </div>
          <!--  -->
          <div class="row view_show">
            <div class="col-sm-4 bor_view">
              <div class="row">
                <h4>项目名称：<span id="multiIndexSpan">日志系统</span></h4>
              </div>
              <div class="form-group">
                <label class="col-sm-3 control-label">
                  项目名称:</label>
                <div class="col-sm-9">
                  <select class="form-control input-sm" onchange="changeMultiIndex()" name="multiIndex" id="multiIndex">
                    <option value="">请选择项目...</option>
                    <th:block th:each="multiIndexBean : ${multiIndexList}">
                      <option th:value="${multiIndexBean.multiIndex}"
                              th:text="${multiIndexBean.multiIndex}"></option>
                    </th:block>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-3 control-label">
                  汇聚列名:</label>
                <div class="col-sm-9">
                  <select class="form-control input-sm" id="xAxis" name="xAxis">
                    <option value="">请选择...</option>
                    <th:block th:each="field : ${fieldList}">
                      <option th:value="${field}"
                              th:text="${field}"></option>
                    </th:block>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-3 control-label">
                  查询时间:</label>
                <div class="col-sm-9">
                  <select class="form-control input-sm" name="lastDay" id="lastDay">
                    <option value="">请选择...</option>
                    <option value="1">最近一天</option>
                    <option value="3">最近三天</option>
                    <option value="7">最近七天</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <label class="col-sm-3 control-label">
                  汇聚方式:</label>
                <div class="col-sm-9">
                  <select class="form-control input-sm" id="converMethod" name="converMethod">
                    <option value="1">count</option>
                  </select>
                </div>
              </div>
              <div class="form-group">
                <div class="col-sm-9"></div>
                <div class="col-sm-2 col-sm-pull-1">
                  <button type="button" class="btn btn-primary" onclick="generatEchart()">生成</button>
                </div>
              </div>
            </div>
            <div class="col-sm-8">
              <div class="bor_view">
                <div id="main_line" class="echart_view show" data-type="1"></div>
                <div id="main_bar" class="echart_view" data-type="2"></div>
                <div id="main_pie" class="echart_view" data-type="3"></div>
              </div>
            </div>
          </div>
        </form>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
          <button type="button" class="btn btn-primary" onclick="saveVisualizeEchart()">保存</button>
        </div>
      </div>
    </div>
  </div><!-- /.modal-content -->
</div><!-- /.modal -->
</div>
<!-- 详情弹出框 -->
<div class="info_content" id="info_content" style="display: none">
  <div class="row">
    <div class="col-sm-6">
      <h5>图表统计名称：电子证照的异常柱状图</h5>
    </div>
    <div class="col-sm-6">
      <h5>项目名称：电子证照</h5>
    </div>
  </div>
  <div class="row">
    <div calss="info_main">
      <div id="info_main_bar" style="width: 500px;height: 500px;margin:auto"></div>
    </div>
  </div>
</div>
<th:block th:include="common/pub_head :: echart"></th:block>
<link rel="stylesheet" type="text/css" th:href="@{/assets/css/page_data.css}"/>
<script type="text/javascript" th:src="@{/assets/js/echart.config.js}"></script>
<script>
  /*<![CDATA[*/
  function detailVisualizeEchart(id) {
    alert(id);
  }

  function delVisualizeEchart(id) {
    alert(id);
  }

  function modifyVisualizeEchart(id) {
    alert(id);
  }

  function saveVisualizeEchart() {
    var formData = $("#list_form").serializeArray();
    var URL = path + "/echartManage/saveVisualizeEchart";

    $.post(URL, formData, function (jsonData) {
      var flag = jsonData.flag;

      if (flag) {
        alert("保存成功");
        $("#Modal_view").modal("hide");
        $("#table").bootstrapTable("refresh");
      } else {
        alert("保存失败");
      }
    });
  }
  function changeType() {
    var type = $("#type").val();
    $(".echart_view").each(function() {
      $(this).removeClass("show");
      if (type == $(this).attr("data-type")) {
        $(this).addClass("show");
      }
    });
  }

  function generatEchart() {
    var index = $("#multiIndex").val();
    var field = $("#xAxis").val();

    var formData = {
      "index": index,
      "field": field
    };
    var URL = path + "/echartManage/generatEchart";

    $.post(URL, formData, function (jsonData) {
      initEchart();
    }, "json");
  }

  var myModalClone = $("#Modal_view").clone();
  var myChart_line = echarts.init(document.getElementById('main_line'));
  var myChart_bar = echarts.init(document.getElementById('main_bar'));
  var myChart_pie = echarts.init(document.getElementById('main_pie'));
  function saveModal() {
    $("#Modal_view").html(myModalClone.html());
    $('#Modal_view').modal('show');
  }

  function initEchart() {
    myChart_line.dispose();
    myChart_line = echarts.init(document.getElementById('main_line'));
    myChart_line.setOption(option_line);

    myChart_bar.dispose();
    myChart_bar = echarts.init(document.getElementById('main_bar'));
    myChart_bar.setOption(option_bar);

    myChart_pie.dispose();
    myChart_pie = echarts.init(document.getElementById('main_pie'));
    myChart_pie.setOption(option_pie);
  }

  function changeMultiIndex() {
    var multiIndex = $("#multiIndex").val();
    $("#multiIndexSpan").html(multiIndex);

    if (multiIndex != "") {
      var URL = path + "/echartManage/listConverField";
      var formData = {
        "index": multiIndex
      };
      $.post(URL, formData, function (fieldList) {
        var domEle = "<option value=''>请选择...</option>";
        for (var i = 0; i < fieldList.length; i++) {
          domEle += "<option value='" + fieldList[i] + "'>" + fieldList[i] + "</option>";
        }
        $("#xAxis").html(domEle);
      }, "json");
    } else {
      var domEle = "<option value=''>请选择..</option>";
      $("#xAxis").html(domEle);
    }
  }

  /*]]>*/
</script>
<script>
  /*<![CDATA[*/
  //复选框选中不可点击添加
  $(window).load(function () {
    $("#table th input[type=checkbox]").on("change", function () {
      var tf = $(this).prop("checked");
      if (tf) {
        $("#add_btn").attr("disabled", "disabled").removeClass("btn-primary")
      } else {
        $("#add_btn").removeAttr("disabled").addClass("btn-primary")
      }
    });
    //点击列表弹出详情
    $(".btn_info").on("click", function () {
      var layerIndex = layer.open({
        type: 1,
        title: '图表详情',
        area: ['100%', '100%'], //宽高
        shadeClose: true,
        content: $("#info_content"),

        yes: function (index, layero) {
          $("#add1_form").submit();
        },
        bnt2: function (index, layero) {
          layer.close(index);
        }
      });
    });
  });

  // 图表类型选择
  $(function () {
    $("#selectView").change(function () {
      var s = $(this).val();
      $('.main_view:eq(' + s + ')').addClass("show").siblings().removeClass("show");
    })
  });
  // 保存按钮
  $("#btn_ok").click(function () {
    var name = $("#firstname").val();
    var select_value = $("#selectView").find("option:selected").text();
    var xAxis = $("#xAxis").find("option:selected").text();
    var yAxis = $("#yAxis").find("option:selected").text();
    alert("你提交的数据是：" + name + "-" + select_value + "-" + xAxis + "-" + yAxis);
    $('#Modal_view').modal('hide')
  });

  $(function () {
    /* var info_Chart_bar = echarts.init(document.getElementById('info_main_bar'));*/
    var info_option_bar = {
      title: {
        text: '柱状图'
      },
      tooltip: {},
      legend: {
        data: ['记录']
      },
      xAxis: {
        data: ["A", "B", "C", "D", "E", "F"]
      },
      yAxis: {},
      series: [{
        name: '记录',
        type: 'bar',
        data: [5, 20, 36, 10, 10, 20]
      }]
    };
    // info_Chart_bar.setOption(info_option_bar);
  })
  /*]]>*/
</script>
<script>
  /*<![CDATA[*/
  var $table = $('#table');
  $table.bootstrapTable({
    classes: 'table table-hover table-condensed table-bordered table-responsive',
    contentType: "application/x-www-form-urlencoded",
    height: getHeight(),
    method: 'post',
    url: path + "/echartManage/pageVisualizeEchart",
    striped: true, //隔行变色
    pagination: true,
    singleSelect: false,
    queryParamsType: '',
    queryParams: queryParams,
    sidePagination: "server",//表格分页的位置
    pageNumber: 1,
    pageSize: 10,
    pageList: [10, 20, 50, 100],
    searchOnEnterKey: true,
    onLoadSuccess: function () {
      $(".bs-checkbox").css({"text-align": "center", "vertical-align": "middle"});
    },
    columns: [{
      checkbox: true,
      width: 50
    }, {
      field: 'id',
      width: 100,
      title: '编号',
      halign: 'center',
      align: 'center',
      valign: 'middle'
    }, {
      field: 'echartName',
      title: '图表名称',
      halign: 'center',
      align: 'left',
      valign: 'middle',
      sortable: true
    }, {
      width: 100,
      field: 'typePo',
      title: '图表类型',
      halign: 'center',
      align: 'center',
      valign: 'middle',
      sortable: true
    }, {
      width: 300,
      field: 'operate',
      title: '操作',
      halign: 'center',
      align: 'center',
      valign: 'middle',
      formatter: operateFormatter
    }
    ]
  });

  function queryParams(params) {
    var paramMap = {
      pageSize: params.pageSize,
      pn: params.pageNumber,
      echartName: $('#echartNameQuery').val()
    };

    return paramMap;
  }

  function operateFormatter(value, row, index) {
    console.log(value, row, index);
    return [
      '<a class="btn btn-primary btn_info" href="javascript:detailVisualizeEchart(' + row.id + ')" title="查看详情">',
      //'<i class="iconfont icon-207"></i>',
      '查看详情',
      '</a>  ',
      '<a class="btn btn-success" href="javascript:modifyVisualizeEchart(' + row.id + ')" title="修改">',
      //'<i class="iconfont icon-xiugai"></i>',
      '修改',
      '</a>  ',
      '<a class="btn btn-danger" href="javascript:delVisualizeEchart(' + row.id + ')" title="删除">',
      //'<i class="iconfont icon-shanchu"></i>',
      '删除',
      '</a>  '
    ].join('');
  }

  $(window).resize(function () {
    $table.bootstrapTable('resetView', {
      height: getHeight()
    });

  });

  function getHeight() {
    return $(window).height() - $(".modal-body").offset().top - 195;
  }

  /*]]>*/
</script>
</body>
</html>